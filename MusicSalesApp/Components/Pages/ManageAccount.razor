@page "/manage-account"
@using MusicSalesApp.Models
@inherits ManageAccountModel

<PageTitle>Manage Account</PageTitle>

<div class="container mt-4">
    <h2>Manage Account</h2>

    @if (_loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!_isAuthenticated)
    {
        <SfMessage Severity="MessageSeverity.Warning">You must be logged in to manage your account.</SfMessage>
    }
    else
    {
        <!-- User Email Section -->
        <div class="user-email-section mb-4">
            <p class="user-email"><strong>Account Email:</strong> @_userEmail</p>
        </div>

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <SfMessage Severity="MessageSeverity.Success">@_successMessage</SfMessage>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <SfMessage Severity="MessageSeverity.Error">@_errorMessage</SfMessage>
        }

        <!-- Password Change Section -->
        <SfCard CssClass="mb-4">
            <CardHeader Title="Change Password" />
            <CardContent>
                <div class="mb-3">
                    <label for="currentPassword" class="e-label">Current Password</label>
                    <SfTextBox @bind-Value="_currentPassword" ID="currentPassword" Type="InputType.Password" Placeholder="Enter current password" CssClass="e-outline" />
                </div>

                <div class="mb-3">
                    <label for="newPassword" class="e-label">New Password</label>
                    <SfTextBox @bind-Value="_newPassword" ID="newPassword" Type="InputType.Password" Placeholder="Enter new password" CssClass="e-outline" />
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="e-label">Confirm New Password</label>
                    <SfTextBox @bind-Value="_confirmPassword" ID="confirmPassword" Type="InputType.Password" Placeholder="Confirm new password" CssClass="e-outline" />
                </div>

                <SfButton IsPrimary="true" Content="Change Password" OnClick="ChangePassword" />
            </CardContent>
        </SfCard>

        <!-- Email Preferences Section -->
        <SfCard CssClass="mb-4">
            <CardHeader Title="Email Preferences" />
            <CardContent>
                <div class="mb-3">
                    <SfCheckBox @bind-Checked="_receiveNewSongEmails" TChecked="bool" />
                    <span class="ms-2">Receive email notifications when new music is added</span>
                </div>
                <SfButton IsPrimary="true" Content="Save Preferences" OnClick="SaveEmailPreferences" />
            </CardContent>
        </SfCard>

        <!-- Passkey Management Section -->
        <SfCard CssClass="mb-4">
            <CardHeader Title="Passkeys" />
            <CardContent>
                <p>Passkeys provide a secure and convenient way to sign in without a password.</p>
                
                @if (_passkeys.Any())
                {
                    <SfGrid DataSource="@_passkeys" AllowPaging="false" CssClass="mt-3">
                        <GridColumns>
                            <GridColumn Field="@nameof(Passkey.Name)" HeaderText="Name" Width="200"></GridColumn>
                            <GridColumn Field="@nameof(Passkey.CreatedAt)" HeaderText="Created" Width="180">
                                <Template>
                                    @{
                                        var passkey = (context as Passkey);
                                        <span>@passkey.CreatedAt.ToLocalTime().ToString("g")</span>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn Field="@nameof(Passkey.LastUsedAt)" HeaderText="Last Used" Width="180">
                                <Template>
                                    @{
                                        var passkey = (context as Passkey);
                                        <span>@passkey.LastUsedAt.ToLocalTime().ToString("g")</span>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn HeaderText="Actions" Width="200">
                                <Template>
                                    @{
                                        var passkey = (context as Passkey);
                                        <div>
                                            <SfButton CssClass="e-small" Content="Rename" OnClick="() => ShowRenameDialog(passkey)" />
                                            <SfButton CssClass="e-small e-danger" Content="Delete" OnClick="() => ShowDeleteConfirmDialog(passkey)" />
                                        </div>
                                    }
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </SfGrid>
                }
                else
                {
                    <p>You don't have any passkeys yet.</p>
                }

                <SfButton IsPrimary="true" Content="Add Passkey" OnClick="ShowAddPasskeyDialog" CssClass="mt-2" />
            </CardContent>
        </SfCard>

        <!-- Subscription Management Section -->
        <SfCard CssClass="mb-4">
            <CardHeader Title="Manage Your Subscription" />
            <CardContent>
                @if (_hasSubscription)
                {
                    <div class="subscription-details">
                        <p><strong>Status:</strong> @_subscriptionStatus</p>
                        <p><strong>Monthly Price:</strong> $@_monthlyPrice</p>
                        @if (_startDate.HasValue)
                        {
                            <p><strong>Started:</strong> @_startDate.Value.ToLocalTime().ToString("MMMM dd, yyyy")</p>
                        }
                        @if (_nextBillingDate.HasValue)
                        {
                            <p><strong>Next Billing Date:</strong> @_nextBillingDate.Value.ToLocalTime().ToString("MMMM dd, yyyy")</p>
                        }
                        @if (_endDate.HasValue)
                        {
                            <p><strong>Access Until:</strong> @_endDate.Value.ToLocalTime().ToString("MMMM dd, yyyy h:mm tt")</p>
                            <p class="subscription-note">Your subscription has been cancelled. You can continue to enjoy unlimited music streaming until @_endDate.Value.ToLocalTime().ToString("MMMM dd, yyyy h:mm tt").</p>
                        }
                        else
                        {
                            <p class="subscription-note">You have unlimited access to all music on our platform.</p>
                        }
                        
                        @if (!_endDate.HasValue && !_cancelling)
                        {
                            <SfButton OnClick="@CancelSubscription" CssClass="e-danger mt-2">Cancel Subscription</SfButton>
                        }
                        else if (_cancelling)
                        {
                            <p>Processing...</p>
                        }
                    </div>
                }
                else
                {
                    <div class="subscription-description">
                        <h3>Subscribe for just $@_subscriptionPrice per month!</h3>
                        <p>Enjoy unlimited streaming of all music on our platform.</p>
                        
                        <div class="subscription-terms mt-3">
                            <h4>Subscription Terms:</h4>
                            <ul>
                                <li>Monthly fee of <strong>$@_subscriptionPrice</strong> will continue until cancelled by the user.</li>
                                <li>The charge will occur on or about the same day each month, subject to PayPal's policy.</li>
                                <li>Once cancelled, the subscription will be in effect until the end of the paid month.</li>
                                <li>You can cancel at any time from this page.</li>
                            </ul>
                        </div>

                        <div class="terms-agreement mt-3">
                            <SfCheckBox @bind-Checked="_agreeToTerms" Label="I agree to the subscription terms and conditions" TChecked="bool" />
                        </div>
                        
                        @if (!_subscribing)
                        {
                            <SfButton OnClick="@Subscribe" Disabled="@(!_agreeToTerms)" CssClass="e-primary mt-2">Sign Up for Monthly Subscription</SfButton>
                        }
                        else
                        {
                            <p>Processing your subscription...</p>
                        }
                    </div>
                }
            </CardContent>
        </SfCard>

        <!-- Become a Seller Section (only shown if user is not already an active seller) -->
        @if (!_isActiveSeller)
        {
            <SfCard CssClass="mb-4">
                <CardHeader Title="Become a Seller" />
                <CardContent>
                    @if (_sellerOnboardingStatus == "NotStarted" || _sellerOnboardingStatus == null)
                    {
                        <div class="seller-description">
                            <h4>Sell Your Music on StreamTunes!</h4>
                            <p>Join our community of artists and start earning money from your music today.</p>
                            
                            <div class="seller-benefits mt-3">
                                <h5>Benefits of becoming a seller:</h5>
                                <ul>
                                    <li>Upload and sell your original music</li>
                                    <li>Reach a global audience of music lovers</li>
                                    <li>Get paid directly to your PayPal business account</li>
                                    <li>You control the pricing of your music</li>
                                    <li>Keep @((1 - _platformCommissionRate) * 100)% of each sale</li>
                                </ul>
                            </div>

                            <div class="seller-requirements mt-3">
                                <h5>Requirements:</h5>
                                <ul>
                                    <li>A PayPal Business account (will be created during signup if you don't have one)</li>
                                    <li>Original music that you have the rights to sell</li>
                                    <li>Agreement to <a href="https://www.paypal.com/us/webapps/mpp/security/seller-protection" target="_blank" rel="noopener noreferrer">PayPal's Seller Protection policy</a></li>
                                </ul>
                            </div>

                            <div class="seller-commission mt-3">
                                <p><strong>Platform Commission:</strong> StreamTunes takes a @(_platformCommissionRate * 100)% commission on each sale. The remaining @((1 - _platformCommissionRate) * 100)% goes directly to you. PayPal fees are additional.</p>
                            </div>

                            <div class="seller-signup-form mt-4">
                                <div class="mb-3">
                                    <label for="sellerDisplayName" class="e-label">Display Name (optional)</label>
                                    <SfTextBox @bind-Value="_sellerDisplayName" ID="sellerDisplayName" Placeholder="Your artist/band name" CssClass="e-outline" />
                                    <small class="form-text text-muted">This name will be shown to buyers on your music listings.</small>
                                </div>

                                <div class="mb-3">
                                    <label for="sellerBio" class="e-label">Bio (optional)</label>
                                    <SfTextBox @bind-Value="_sellerBio" ID="sellerBio" Multiline="true" Placeholder="Tell buyers about yourself and your music" CssClass="e-outline" />
                                </div>

                                @if (!_startingOnboarding)
                                {
                                    <SfButton IsPrimary="true" Content="Start Seller Signup" OnClick="StartSellerOnboarding" />
                                }
                                else
                                {
                                    <p>Preparing your signup...</p>
                                }
                            </div>
                        </div>
                    }
                    else if (_sellerOnboardingStatus == "Pending")
                    {
                        <div class="seller-pending">
                            <h4>Complete Your PayPal Signup</h4>
                            <p>You've started the seller signup process. Please complete your PayPal Business account setup to start selling.</p>
                            
                            @if (!string.IsNullOrEmpty(_sellerReferralUrl))
                            {
                                <p><a href="@_sellerReferralUrl" target="_blank" class="btn btn-primary">Continue with PayPal</a></p>
                            }
                            
                            <p class="mt-3">After completing PayPal setup, return here and click the button below:</p>
                            @if (!_completingOnboarding)
                            {
                                <SfButton IsPrimary="true" Content="I've Completed PayPal Setup" OnClick="CompleteSellerOnboarding" />
                            }
                            else
                            {
                                <p>Verifying your PayPal setup...</p>
                            }
                        </div>
                    }
                    else if (_sellerOnboardingStatus == "InProgress")
                    {
                        <div class="seller-in-progress">
                            <h4>Verification In Progress</h4>
                            <p>Your PayPal account is being verified. This may take a few minutes to a few hours.</p>
                            <p>Once verified, you'll be able to start uploading and selling your music.</p>
                            
                            @if (!_completingOnboarding)
                            {
                                <SfButton Content="Check Status" OnClick="CompleteSellerOnboarding" />
                            }
                            else
                            {
                                <p>Checking status...</p>
                            }
                        </div>
                    }
                    else if (_sellerOnboardingStatus == "Failed")
                    {
                        <div class="seller-failed">
                            <h4>Onboarding Failed</h4>
                            <p class="text-danger">Unfortunately, your seller onboarding could not be completed. This may be due to PayPal verification issues.</p>
                            <p>Please contact support for assistance or try again:</p>
                            
                            @if (!_startingOnboarding)
                            {
                                <SfButton IsPrimary="true" Content="Try Again" OnClick="StartSellerOnboarding" />
                            }
                            else
                            {
                                <p>Preparing your signup...</p>
                            }
                        </div>
                    }
                </CardContent>
            </SfCard>
        }
        else
        {
            <!-- Seller Profile Section (shown for active sellers) -->
            <SfCard CssClass="mb-4">
                <CardHeader Title="Seller Profile" />
                <CardContent>
                    <div class="seller-active-info">
                        <p class="text-success"><strong>âœ“ You are an active seller!</strong></p>
                        <p>You can upload and sell your music on StreamTunes.</p>
                        
                        <div class="mt-3">
                            <p><strong>Display Name:</strong> @(_sellerDisplayName ?? "Not set")</p>
                            <p><strong>Commission Rate:</strong> @(_platformCommissionRate * 100)% platform fee</p>
                        </div>

                        <div class="mt-3">
                            <SfButton IsPrimary="true" Content="Upload Music" OnClick="NavigateToUpload" />
                            <SfButton Content="Manage My Songs" OnClick="NavigateToManageSongs" CssClass="ms-2" />
                        </div>

                        <hr class="my-4" />

                        <div class="stop-selling-section">
                            <h5 class="text-danger">Stop Being a Seller</h5>
                            <p class="text-muted">
                                If you no longer want to sell music on StreamTunes, you can stop being a seller. 
                                <strong>Warning:</strong> This action will:
                            </p>
                            <ul class="text-muted">
                                <li>Remove all your uploaded music from the platform</li>
                                <li>Delete all your song files from storage</li>
                                <li>Your music will no longer be available for purchase or streaming</li>
                                <li>You will need to go through the seller onboarding process again if you want to sell in the future</li>
                            </ul>
                            <p class="text-muted">
                            See our <a href="/terms-of-use" target="_blank">Terms of Use</a> for more details.
                            </p>
                            
                            @if (!_stoppingSellerStatus)
                            {
                                <SfButton CssClass="e-danger" Content="Stop Being a Seller" OnClick="ShowStopSellingConfirmation" />
                            }
                            else
                            {
                                <p>Processing...</p>
                            }
                        </div>
                    </div>
                </CardContent>
            </SfCard>
        }

        <!-- Account Closure Section -->
        <SfCard CssClass="mb-4">
            <CardHeader Title="Close Account" />
            <CardContent>
                <p class="text-danger">Warning: Closing your account will prevent you from logging in.</p>
                <SfButton CssClass="e-danger" Content="Close My Account" OnClick="ShowAccountClosureDialog" />
            </CardContent>
        </SfCard>
    }
</div>

<!-- Add Passkey Dialog -->
<SfDialog @ref="_addPasskeyDialog" Width="400px" IsModal="true" ShowCloseIcon="true" Visible="false">
    <DialogTemplates>
        <Header>Add Passkey</Header>
        <Content>
            <div class="mb-3">
                <label for="passkeyName" class="e-label">Passkey Name</label>
                <SfTextBox @bind-Value="_newPasskeyName" ID="passkeyName" Placeholder="e.g., My Laptop, iPhone" CssClass="e-outline" />
                <small class="form-text text-muted">Choose a name to help you identify this passkey.</small>
            </div>
        </Content>
        <FooterTemplate>
            <SfButton IsPrimary="true" Content="Create" OnClick="AddPasskey" />
            <SfButton Content="Cancel" OnClick="CloseAddPasskeyDialog" />
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Rename Passkey Dialog -->
<SfDialog @ref="_renamePasskeyDialog" Width="400px" IsModal="true" ShowCloseIcon="true" Visible="false">
    <DialogTemplates>
        <Header>Rename Passkey</Header>
        <Content>
            <div class="mb-3">
                <label for="renamePasskeyName" class="e-label">New Name</label>
                <SfTextBox @bind-Value="_renamePasskeyName" ID="renamePasskeyName" Placeholder="Enter new name" CssClass="e-outline" />
            </div>
        </Content>
        <FooterTemplate>
            <SfButton IsPrimary="true" Content="Save" OnClick="RenamePasskey" />
            <SfButton Content="Cancel" OnClick="CloseRenameDialog" />
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Delete Passkey Confirm Dialog -->
<SfDialog @ref="_deletePasskeyDialog" Width="400px" IsModal="true" ShowCloseIcon="true" Visible="false">
    <DialogTemplates>
        <Header>Delete Passkey</Header>
        <Content>
            <p>Are you sure you want to delete the passkey "@_selectedPasskey?.Name"?</p>
        </Content>
        <FooterTemplate>
            <SfButton CssClass="e-danger" Content="Delete" OnClick="DeletePasskey" />
            <SfButton Content="Cancel" OnClick="CloseDeletePasskeyDialog" />
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Account Closure Options Dialog -->
<SfDialog @ref="_accountClosureDialog" Width="600px" IsModal="true" ShowCloseIcon="true" Visible="false">
    <DialogTemplates>
        <Header>Close Account</Header>
        <Content>
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <SfMessage Severity="MessageSeverity.Error" CssClass="mb-3">@_errorMessage</SfMessage>
            }
            @if (_hasPurchasedMusic)
            {
                <div class="mb-3">
                    <p><strong>You have purchased music on this website.</strong></p>
                    <p>Please choose how you would like to close your account:</p>
                    
                    <div class="alert alert-warning mt-3">
                        <h6>Suspend Account</h6>
                        <p>You will not be able to log in, and you will not receive any communications from us. If you decide to re-enable your account in the future, you will still have access to your owned songs.</p>
                    </div>
                    
                    <div class="alert alert-danger mt-3">
                        <h6>Delete Account Permanently</h6>
                        <p>All your data including purchases, playlists, and subscriptions will be permanently deleted. You will no longer have access to your music if you create a new account in the future. <strong>This action cannot be undone!</strong></p>
                    </div>
                </div>
            }
            else
            {
                <div class="mb-3">
                    <p class="text-danger"><strong>Warning:</strong> This action cannot be undone!</p>
                    <p>All your data including playlists and subscriptions will be permanently deleted.</p>
                </div>
            }
        </Content>
        <FooterTemplate>
            @if (_hasPurchasedMusic)
            {
                <SfButton IsPrimary="true" Content="Suspend Account" OnClick="ShowSuspendConfirmDialog" />
                <SfButton CssClass="e-danger" Content="Delete Permanently" OnClick="ShowDeleteConfirmDialog" />
                <SfButton Content="Cancel" OnClick="CloseAccountClosureDialog" />
            }
            else
            {
                <SfButton CssClass="e-danger" Content="Delete Account" OnClick="ShowDeleteConfirmDialog" />
                <SfButton Content="Cancel" OnClick="CloseAccountClosureDialog" />
            }
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Suspend Account Confirm Dialog -->
<SfDialog @ref="_suspendAccountDialog" Width="500px" IsModal="true" ShowCloseIcon="true" Visible="false">
    <DialogTemplates>
        <Header>Suspend Account</Header>
        <Content>
            <p>Type your email address to confirm account suspension:</p>
            <SfTextBox @bind-Value="_accountActionConfirmEmail" Placeholder="Enter your email" CssClass="e-outline" />
            <div class="mt-3">
                <small class="text-muted">You can re-enable your account by contacting support.</small>
            </div>
        </Content>
        <FooterTemplate>
            <SfButton IsPrimary="true" Content="Suspend My Account" OnClick="SuspendAccount" />
            <SfButton Content="Cancel" OnClick="CloseSuspendAccountDialog" />
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Delete Account Confirm Dialog -->
<SfDialog @ref="_deleteAccountDialog" Width="500px" IsModal="true" ShowCloseIcon="true" Visible="false">
    <DialogTemplates>
        <Header>Delete Account</Header>
        <Content>
            <p class="text-danger"><strong>Warning:</strong> This action cannot be undone!</p>
            <p>All your data including purchases, playlists, and subscriptions will be permanently deleted.</p>
            <p>Type your email address to confirm:</p>
            <SfTextBox @bind-Value="_accountActionConfirmEmail" Placeholder="Enter your email" CssClass="e-outline" />
        </Content>
        <FooterTemplate>
            <SfButton CssClass="e-danger" Content="Delete My Account" OnClick="DeleteAccount" />
            <SfButton Content="Cancel" OnClick="CloseDeleteAccountDialog" />
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Stop Selling Confirmation Dialog -->
<SfDialog @ref="_stopSellingDialog" Width="500px" IsModal="true" ShowCloseIcon="true" Header="Stop Being a Seller">
    <DialogTemplates>
        <Content>
            <p class="text-danger"><strong>Warning:</strong> This action cannot be undone!</p>
            <p>By stopping your seller account:</p>
            <ul>
                <li>All your uploaded music will be permanently removed from the platform</li>
                <li>All your song files will be deleted from storage</li>
                <li>Your music will no longer be available for purchase or streaming</li>
                <li><strong>Users who previously purchased your music will no longer be able to access it</strong></li>
            </ul>
            <p>To confirm, please type your email address below:</p>
            <SfTextBox @bind-Value="_stopSellingConfirmEmail" Placeholder="Enter your email" CssClass="e-outline" />
        </Content>
        <FooterTemplate>
            <SfButton CssClass="e-danger" Content="Stop Being a Seller" OnClick="ConfirmStopSelling" Disabled="@(_stopSellingConfirmEmail != _userEmail)" />
            <SfButton Content="Cancel" OnClick="CloseStopSellingDialog" />
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>
