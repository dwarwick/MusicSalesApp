@page "/admin/users"
@inherits AdminUserManagementModel
@using Microsoft.AspNetCore.Authorization
@using MusicSalesApp.Common.Helpers
@attribute [Authorize(Policy = Permissions.ManageUsers)]

<PageTitle>User Management</PageTitle>

<h3>User Management</h3>

@if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading users...</p>
    </div>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> @_errorMessage
    </div>
}
else
{
    <div id="grid-container">
        <SfGrid @ref="_grid"
                TValue="UserViewModel"
                DataSource="@_users"
                AllowPaging="true"
                AllowSorting="true"
                AllowFiltering="true"
                Height="100%"
                Width="100%"
                EnableAdaptiveUI="false"
                RowRenderingMode="Syncfusion.Blazor.Grids.RowDirection.Horizontal">
            <GridPageSettings PageSize="10"></GridPageSettings>
            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
            <GridColumns>
                <GridColumn HeaderText="Action" Width="100" AllowFiltering="false" AllowSorting="false">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            <SfButton OnClick="() => EditUser(user!)" IsPrimary="true" CssClass="e-btn e-small e-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </SfButton>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.Id)" HeaderText="ID" Width="80"></GridColumn>
                <GridColumn Field="@nameof(UserViewModel.UserName)" HeaderText="Username" Width="150"></GridColumn>
                <GridColumn Field="@nameof(UserViewModel.Email)" HeaderText="Email" Width="200"></GridColumn>
                <GridColumn Field="@nameof(UserViewModel.EmailConfirmed)" HeaderText="Email Confirmed" Width="130">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.EmailConfirmed)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.PhoneNumber)" HeaderText="Phone Number" Width="140">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            <span>@(string.IsNullOrEmpty(user!.PhoneNumber) ? "-" : user.PhoneNumber)</span>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.PhoneNumberConfirmed)" HeaderText="Phone Confirmed" Width="130">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.PhoneNumberConfirmed)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.LockoutEnd)" HeaderText="Lockout End" Width="180">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.LockoutEnd.HasValue)
                            {
                                <span>@user.LockoutEnd.Value.LocalDateTime.ToString("g")</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.LockoutEnabled)" HeaderText="Lockout Enabled" Width="130">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.LockoutEnabled)
                            {
                                <span class="badge bg-warning">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.AccessFailedCount)" HeaderText="Failed Logins" Width="120"></GridColumn>
                <GridColumn Field="@nameof(UserViewModel.LastVerificationEmailSent)" HeaderText="Last Verification Sent" Width="180">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.LastVerificationEmailSent.HasValue)
                            {
                                <span>@user.LastVerificationEmailSent.Value.ToString("g")</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.Theme)" HeaderText="Theme" Width="100"></GridColumn>
                <GridColumn Field="@nameof(UserViewModel.IsSuspended)" HeaderText="Suspended" Width="120">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.IsSuspended)
                            {
                                <span class="badge bg-danger">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.SuspendedAt)" HeaderText="Suspended At" Width="180">
                    <Template>
                        @{
                            var user = (context as UserViewModel);
                            if (user!.SuspendedAt.HasValue)
                            {
                                <span>@user.SuspendedAt.Value.ToString("g")</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserViewModel.Roles)" HeaderText="Roles" Width="150"></GridColumn>
            </GridColumns>
        </SfGrid>

        <div class="mt-3">
            <p class="text-muted">Total: @_users.Count users</p>
        </div>
    </div>
}

<!-- Edit Dialog -->
<SfDialog @bind-Visible="_showEditModal" Width="600px" IsModal="true" ShowCloseIcon="true">
    <DialogTemplates>
        <Header>Edit User</Header>
        <Content>
            @if (_editingUser != null)
            {
                <div class="dialog-content">
                    @if (_validationErrors.Any())
                    {
                        <SfMessage Severity="MessageSeverity.Error">
                            <strong>Validation Errors:</strong>
                            <ul>
                                @foreach (var error in _validationErrors)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </SfMessage>
                    }

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="e-label">ID</label>
                            <SfTextBox Value="@_editingUser.Id.ToString()" Enabled="false" CssClass="e-outline" />
                        </div>
                        <div class="col-md-6">
                            <label class="e-label">Username</label>
                            <SfTextBox Value="@_editingUser.UserName" Enabled="false" CssClass="e-outline" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="e-label">Email <span class="text-danger">*</span></label>
                            <SfTextBox @bind-Value="_editEmail" CssClass="e-outline" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <SfCheckBox @bind-Checked="_editEmailConfirmed" Label="Email Confirmed" CssClass="e-outline"></SfCheckBox>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="e-label">Phone Number</label>
                            <SfTextBox @bind-Value="_editPhoneNumber" CssClass="e-outline" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <SfCheckBox @bind-Checked="_editPhoneNumberConfirmed" Label="Phone Number Confirmed" CssClass="e-outline"></SfCheckBox>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <SfCheckBox @bind-Checked="_editLockoutEnabled" Label="Lockout Enabled" CssClass="e-outline"></SfCheckBox>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="e-label">Lockout End</label>
                            <SfDateTimePicker @bind-Value="_editLockoutEnd" CssClass="e-outline" ShowClearButton="true" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <SfCheckBox @bind-Checked="_editIsSuspended" Label="Suspended" CssClass="e-outline"></SfCheckBox>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="e-label">Access Failed Count</label>
                            <SfTextBox Value="@_editingUser.AccessFailedCount.ToString()" Enabled="false" CssClass="e-outline" />
                        </div>
                        <div class="col-md-6">
                            <label class="e-label">Theme</label>
                            <SfDropDownList TValue="string" TItem="string" 
                                          @bind-Value="_editTheme" 
                                          DataSource="@_themeOptions"
                                          Placeholder="Select Theme"
                                          CssClass="e-outline">
                            </SfDropDownList>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="e-label">Roles</label>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                @foreach (var role in _editSelectedRoles)
                                {
                                    <span class="badge bg-primary d-flex align-items-center gap-1">
                                        @role
                                        <button type="button" class="btn-close btn-close-white" 
                                                style="font-size: 0.5rem;" 
                                                @onclick="() => RemoveRole(role)"
                                                aria-label="Remove @role"></button>
                                    </span>
                                }
                            </div>
                            <SfDropDownList TValue="string" TItem="string" 
                                          Value="@_selectedRoleToAdd"
                                          DataSource="@GetUnassignedRoles()"
                                          Placeholder="Add Role"
                                          CssClass="e-outline">
                                <DropDownListEvents TValue="string" TItem="string" ValueChange="@OnRoleSelected"></DropDownListEvents>
                            </SfDropDownList>
                        </div>
                    </div>
                </div>
            }
        </Content>
        <FooterTemplate>
            <SfButton OnClick="CancelEdit" Content="Cancel" CssClass="e-btn" />
            <SfButton OnClick="SaveEdit" IsPrimary="true" Disabled="@_isSaving" CssClass="e-btn e-primary">
                @if (_isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                }
                Save Changes
            </SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>
