@page "/my-playlists"
@using Microsoft.AspNetCore.Authorization
@using MusicSalesApp.Common.Helpers
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Cards
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Popups
@inherits MyPlaylistsModel
@attribute [Authorize(Policy = Permissions.ValidatedUser)]

<PageTitle>My Playlists</PageTitle>

<div class="playlists-page-container">
    <div class="playlists-page-header">
        <h3>My Playlists</h3>
        <SfButton OnClick="@ShowCreatePlaylistDialog" CssClass="e-success">
            <span class="e-btn-icon fas fa-plus"></span>
            Create Playlist
        </SfButton>
    </div>

    @if (!_hasActiveSubscription && !_hasOwnedSongs && !_loading)
    {
        <div class="subscription-warning">
            <div class="e-alert e-alert-warning">
                <strong>Limited Access:</strong> To create playlists, you need to either have an active subscription or own at least one song. 
                <a href="/manage-account">Subscribe now</a> for unlimited access or <a href="/music-library">browse the library</a> to purchase songs.
            </div>
        </div>
    }

    @if (_loading)
    {
        <div class="loading-state">
            <p>Loading playlists...</p>
        </div>
    }
    else if (_error != null)
    {
        <div class="error-state">
            <div class="e-alert e-alert-danger">@_error</div>
        </div>
    }
    else if (_playlists == null || !_playlists.Any())
    {
        <div class="empty-state">
            <p>You don't have any playlists yet. Create one to get started!</p>
        </div>
    }
    else
    {
        <div class="playlists-page-grid">
            @foreach (var playlist in _playlists)
            {
                <SfCard CssClass="playlists-page-card music-card">
                    <CardHeader Title="@playlist.PlaylistName">
                        <div class="playlists-page-actions">
                            <SfButton OnClick="@(() => ShowEditPlaylistDialog(playlist))" CssClass="e-small" IconCss="fas fa-edit" />
                            <SfButton OnClick="@(() => ShowDeletePlaylistDialog(playlist))" CssClass="e-small e-danger" IconCss="fas fa-trash" />
                        </div>                       
                    </CardHeader>
                    <CardContent>
                        <div class="playlists-page-info">
                            <p>@_playlistSongCounts.GetValueOrDefault(playlist.Id, 0) song(s)</p>
                            <p class="playlists-page-date">Created: @playlist.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")</p>
                        </div>
                        <div class="card-actions">
                            <SfButton OnClick="@(() => PlayPlaylist(playlist))">
                                <SfIcon IconCss="fas fa-solid fa-play" />
                            </SfButton>
                            <SfButton OnClick="@(() => ViewPlaylist(playlist))">
                                <SfIcon IconCss="fas fa-solid fa-eye" />
                            </SfButton>
                        </div>
                    </CardContent>
                </SfCard>
            }
        </div>
    }

    @if (_selectedPlaylist != null && _viewingSongs)
    {
        <div class="playlists-page-songs-section">
            <div class="playlists-page-songs-header">
                <h4>@_selectedPlaylist.PlaylistName</h4>
                <div>
                    <SfButton OnClick="@ShowAddSongDialog" CssClass="e-success">
                        <span class="e-btn-icon fas fa-plus"></span>
                        Add Song
                    </SfButton>
                    <SfButton OnClick="@ClosePlaylistView" CssClass="e-outline">
                        Close
                    </SfButton>
                </div>
            </div>

            @if (_playlistSongs == null || !_playlistSongs.Any())
            {
                <p>This playlist is empty. Add some songs!</p>
            }
            else
            {
                <div class="playlists-page-songs-list">
                    @foreach (var userPlaylist in _playlistSongs)
                    {
                        var songMetadata = userPlaylist.OwnedSong?.SongMetadata;
                        if (songMetadata != null)
                        {
                            <div class="playlists-page-song-item">
                                <div class="playlists-page-song-info">
                                    <span class="playlists-page-song-title">@GetSongTitle(songMetadata)</span>
                                    @if (!string.IsNullOrEmpty(songMetadata.Genre))
                                    {
                                        <span class="playlists-page-song-genre">@songMetadata.Genre</span>
                                    }
                                </div>
                                <SfButton OnClick="@(() => RemoveSongFromPlaylist(userPlaylist))"
                                          CssClass="e-small e-danger"
                                          IconCss="fas fa-times" />
                            </div>
                        }
                    }
                </div>
            }
        </div>
    }
</div>

<!-- Create/Edit Playlist Dialog -->
<SfDialog @bind-Visible="_showPlaylistDialog" Width="400px" IsModal="true">
    <DialogTemplates>
        <Header>@(_editingPlaylist == null ? "Create Playlist" : "Edit Playlist")</Header>
        <Content>
            <div class="playlists-page-dialog-content">
                <SfTextBox @bind-Value="_playlistName" Placeholder="Playlist Name" />
            </div>
        </Content>
        <FooterTemplate>
            <SfButton OnClick="@SavePlaylist" IsPrimary="true">Save</SfButton>
            <SfButton OnClick="@ClosePlaylistDialog">Cancel</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Delete Playlist Confirmation Dialog -->
<SfDialog @bind-Visible="_showDeleteDialog" Width="400px" IsModal="true">
    <DialogTemplates>
        <Header>Delete Playlist</Header>
        <Content>
            <p>Are you sure you want to delete "@_playlistToDelete?.PlaylistName"?</p>
        </Content>
        <FooterTemplate>
            <SfButton OnClick="@ConfirmDeletePlaylist" CssClass="e-danger">Delete</SfButton>
            <SfButton OnClick="@CloseDeleteDialog">Cancel</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Add Song to Playlist Dialog -->
<SfDialog @bind-Visible="_showAddSongDialog" Width="500px" IsModal="true">
    <DialogTemplates>
        <Header>Add Song to Playlist</Header>
        <Content>
            @if (_availableSongs == null || !_availableSongs.Any())
            {
                <p>You don't have any songs available to add to this playlist.</p>
            }
            else
            {
                <div class="playlists-page-add-song-list">
                    @foreach (var ownedSong in _availableSongs)
                    {
                        var songMetadata = ownedSong.SongMetadata;
                        if (songMetadata != null)
                        {
                            <div class="playlists-page-add-song-item">
                                <span>@GetSongTitle(songMetadata)</span>
                                <SfButton OnClick="@(() => AddSongToPlaylist(ownedSong.Id))"
                                          CssClass="e-small e-success">
                                    Add
                                </SfButton>
                            </div>
                        }
                    }
                </div>
            }
        </Content>
        <FooterTemplate>
            <SfButton OnClick="@CloseAddSongDialog">Close</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>
