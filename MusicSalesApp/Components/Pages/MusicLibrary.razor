@page "/music-library"
@inherits MusicSalesApp.Components.Pages.MusicLibraryModel
@using MusicSalesApp.Services
@using MusicSalesApp.Components.Shared

<h3>Music Library</h3>

@if (!_hasActiveSubscription)
{
    <AuthorizeView>
        <Authorized>
            <SfRadioButton TChecked="string" Label="All Music" Name="musicFilter" Value="All" @bind-Checked="_filterModeString"></SfRadioButton>
            <SfRadioButton TChecked="string" Label="Owned" Name="musicFilter" Value="Owned" @bind-Checked="_filterModeString"></SfRadioButton>
            <SfRadioButton TChecked="string" Label="Not Owned" Name="musicFilter" Value="NotOwned" @bind-Checked="_filterModeString"></SfRadioButton>
        </Authorized>
    </AuthorizeView>
}

@if (_loading)
{
    <div class="loading-state">
        <p>Loading...</p>
    </div>
}
else if (_error != null)
{
    <div class="error-state">
        <div class="alert alert-danger">@_error</div>
    </div>
}
else
{
    <div class="music-cards-grid">
        @* Album Cards *@
        @foreach (var album in GetFilteredAlbums())
        {
            var cardId = GetAlbumCardId(album);
            var isPlaying = IsCardPlaying(cardId);
            var owned = IsAlbumOwned(album);
            var inCart = IsAlbumInCart(album);

            <SfCard CssClass="music-card album-card">
                <!-- Album Art -->
                <div class="card-album-art">
                    @if (!string.IsNullOrEmpty(album.CoverArtUrl))
                    {
                        <img src="@album.CoverArtUrl" alt="Album Art" />
                    }
                    else
                    {
                        <div class="card-album-art-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-placeholder-icon">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z" />
                            </svg>
                        </div>
                    }
                    @if (owned)
                    {
                        <div class="owned-badge">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                    }
                    <div class="album-badge">Album</div>
                </div>

                <!-- Album Title -->
                <div class="card-song-title" title="@album.AlbumName">@album.AlbumName</div>
                <div class="card-track-count">@album.Tracks.Count track@(album.Tracks.Count != 1 ? "s" : "")</div>

                @if (isPlaying)
                {
                    <!-- Mini Player Controls for Album -->
                    <div class="card-mini-player">
                        <!-- Hidden Audio Element -->
                        <audio @ref="_activeAudioElement"
                               preload="auto"
                               class="card-audio-hidden"></audio>

                        <!-- Now Playing Track Name -->
                        <div class="card-now-playing">@GetCurrentAlbumTrackName()</div>

                        <!-- Controls Row: Play/Pause, Stop, Volume -->
                        <div class="card-mini-controls-row">
                            <div class="card-mini-controls">
                                <!-- Play/Pause Button -->
                                <SfButton OnClick=@(() => ToggleCardPlay(cardId)) title="@(IsCardCurrentlyPlaying(cardId) ? "Pause" : "Play")">
                                    @if (IsCardCurrentlyPlaying(cardId))
                                    {
                                        <SfIcon IconCss="fas fa-solid fa-pause" />
                                    }
                                    else
                                    {
                                        <SfIcon IconCss="fas fa-solid fa-play" />
                                    }
                                </SfButton>

                                <!-- Stop Button -->
                                <SfButton OnClick=@(() => StopCard(cardId)) title="Stop">
                                    <SfIcon IconCss="fas fa-solid fa-stop" />
                                </SfButton>
                            </div>

                            <!-- Volume Controls -->
                            <div class="card-volume-controls">
                                <button class="card-volume-button" @onclick="() => ToggleCardMute(cardId)" title="@(IsCardMuted(cardId) ? "Unmute" : "Mute")">
                                    @if (IsCardMuted(cardId) || GetCardVolume(cardId) == 0)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-volume-icon">
                                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89 .86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67 .52-1.42 .93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z" />
                                        </svg>
                                    }
                                    else if (GetCardVolume(cardId) < 0.5)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-volume-icon">
                                            <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-volume-icon">
                                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89 .86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                                        </svg>
                                    }
                                </button>
                                <div @ref="_activeVolumeBarElement" class="card-volume-bar-container" @onclick="(e) => OnCardVolumeBarClick(e, cardId)">
                                    <div class="card-volume-bar" style="width: @(GetCardVolume(cardId) * 100)%;">
                                        <div class="card-volume-thumb"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bar Row -->
                        <div class="card-progress-container">
                            <span class="card-time-display">@FormatTime(GetCardCurrentTime(cardId))</span>
                            <div @ref="_activeProgressBarElement" class="card-progress-bar-container @(IsCurrentPlayingTrackRestricted() ? "restricted" : "")" @onclick="(e) => OnCardProgressBarClick(e, cardId)">
                                <div class="card-progress-bar" style="width: @(GetCardProgressPercentage(cardId))%;">
                                    <div class="card-progress-thumb"></div>
                                </div>
                                @if (IsCurrentPlayingTrackRestricted())
                                {
                                    <div class="card-progress-limit-marker" style="left: @(GetCardPreviewLimitPercentage(cardId))%;"></div>
                                }
                            </div>
                            <span class="card-time-display">@FormatTime(GetCardDisplayDuration(cardId))</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Card Actions: Play button, Like/Dislike, and View button -->
                    <div class="card-actions-with-likes">
                        <div class="action-column">
                            <SfButton CssClass="action-button" onclick=@(() => PlayAlbum(album)) title="play"><SfIcon IconCss="fas fa-solid fa-play" /></SfButton>
                        </div>
                        <LikeDislikeButtons SongMetadataId="album.MetadataId" VerticalLayout="false" />
                        <div class="action-column">
                            <SfButton CssClass="action-button" onclick=@(() => GetAlbumPlayerUrl(album)) title="view"><SfIcon IconCss="fas fa-solid fa-eye" /></SfButton>
                        </div>
                    </div>
                }

                <!-- Bottom row: Add to Cart and Share buttons -->
                <div class="card-bottom-row">
                    <AuthorizeView>
                        <Authorized>
                            @if (!owned && !_hasActiveSubscription)
                            {
                                <div class="cart-button-wrapper">
                                    <SfButton CssClass="@($"card-cart-button {(inCart ? "in-cart" : "")} {(_animatingCartButtons.Contains(album.AlbumName) ? "animating" : "")}")"
                                              OnClick="@(args => ToggleAlbumCartItem(album))"
                                              Title="@(inCart ? "Remove from Cart" : "Add to Cart")">
                                        @if (inCart)
                                        {
                                            <SfIcon IconCss="fas fa-regular fa-circle-check" />
                                            <span>Added</span>
                                        }
                                        else
                                        {
                                            <SfIcon IconCss="fas fa-shopping-cart" />
                                            <span>$@album.Price.ToString("F2")</span>
                                        }
                                    </SfButton>
                                    @if (_animatingCartButtons.Contains(album.AlbumName))
                                    {
                                        <div class="music-note-float">♪</div>
                                    }
                                </div>
                            }
                        </Authorized>
                    </AuthorizeView>
                    
                    <!-- Facebook Share Button -->
                    <FacebookShareButton ShareUrl="@GetAlbumShareUrl(album.AlbumName)" 
                                       Layout="button_count" 
                                       Size="small" 
                                       CssClass="share-button-card" />
                </div>
            </SfCard>
        }

        @* Individual Song Cards *@
        @foreach (var f in GetFilteredFiles())
        {
            var cardId = GetCardId(f.Name);
            var isPlaying = IsCardPlaying(cardId);
            var albumArtUrl = GetAlbumArtUrl(f.Name);
            var owned = IsSongOwned(f.Name);
            var inCart = IsSongInCart(f.Name);

            <SfCard CssClass="music-card">
                <!-- Album Art -->
                <div class="card-album-art">
                    @if (!string.IsNullOrEmpty(albumArtUrl))
                    {
                        <img src="@albumArtUrl" alt="Album Art" />
                    }
                    else
                    {
                        <div class="card-album-art-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-placeholder-icon">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                            </svg>
                        </div>
                    }
                    @if (owned)
                    {
                        <div class="owned-badge">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                    }
                </div>

                <!-- Song Title -->
                <div class="card-song-title" title="@GetDisplayTitle(f.Name)">@GetDisplayTitle(f.Name)</div>
                <!-- Stream Count -->
                <div class="card-stream-count">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-stream-icon">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    @GetSongStreamCount(f.Name).ToString("N0") streams
                </div>

                @if (isPlaying)
                {
                    <!-- Mini Player Controls -->
                    <div class="card-mini-player">
                        <!-- Hidden Audio Element -->
                        <audio @ref="_activeAudioElement"
                               preload="auto"
                               class="card-audio-hidden"></audio>

                        <!-- Controls Row: Play/Pause, Stop, Volume -->
                        <div class="card-mini-controls-row">
                            <div class="card-mini-controls">
                                <!-- Play/Pause Button -->

                                <SfButton OnClick=@(() => ToggleCardPlay(cardId)) title="@(IsCardCurrentlyPlaying(cardId) ? "Pause" : "Play")">
                                    @if (IsCardCurrentlyPlaying(cardId))
                                    {
                                        <SfIcon IconCss="fas fa-solid fa-pause" />
                                    }
                                    else
                                    {
                                        <SfIcon IconCss="fas fa-solid fa-play" />
                                    }
                                </SfButton>

                                <!-- Stop Button -->
                                <SfButton OnClick=@(() => StopCard(cardId)) title="Stop">
                                    <SfIcon IconCss="fas fa-solid fa-stop" />
                                </SfButton>
                            </div>

                            <!-- Volume Controls -->
                            <div class="card-volume-controls">
                                <button class="card-volume-button" @onclick="() => ToggleCardMute(cardId)" title="@(IsCardMuted(cardId) ? "Unmute" : "Mute")">
                                    @if (IsCardMuted(cardId) || GetCardVolume(cardId) == 0)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-volume-icon">
                                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89 .86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67 .52-1.42 .93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z" />
                                        </svg>
                                    }
                                    else if (GetCardVolume(cardId) < 0.5)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-volume-icon">
                                            <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="card-volume-icon">
                                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89 .86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                                        </svg>
                                    }
                                </button>
                                <div @ref="_activeVolumeBarElement" class="card-volume-bar-container" @onclick="(e) => OnCardVolumeBarClick(e, cardId)">
                                    <div class="card-volume-bar" style="width: @(GetCardVolume(cardId) * 100)%;">
                                        <div class="card-volume-thumb"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bar Row -->
                        <div class="card-progress-container">
                            <span class="card-time-display">@FormatTime(GetCardCurrentTime(cardId))</span>
                            <div @ref="_activeProgressBarElement" class="card-progress-bar-container @(IsCurrentPlayingTrackRestricted() ? "restricted" : "")" @onclick="(e) => OnCardProgressBarClick(e, cardId)">
                                <div class="card-progress-bar" style="width: @(GetCardProgressPercentage(cardId))%;">
                                    <div class="card-progress-thumb"></div>
                                </div>
                                @if (IsCurrentPlayingTrackRestricted())
                                {
                                    <div class="card-progress-limit-marker" style="left: @(GetCardPreviewLimitPercentage(cardId))%;"></div>
                                }
                            </div>
                            <span class="card-time-display">@FormatTime(GetCardDisplayDuration(cardId))</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Card Actions: Play button, Like/Dislike, and View button -->
                    <div class="card-actions-with-likes">
                        <div class="action-column">
                            <SfButton CssClass="action-button" onclick=@(() => PlayCard(f.Name)) title="play"><SfIcon IconCss="fas fa-solid fa-play" /></SfButton>
                        </div>
                        <LikeDislikeButtons SongMetadataId="GetSongMetadataId(f.Name)" VerticalLayout="false" />
                        <div class="action-column">
                            <SfButton CssClass="action-button" onclick=@(() => GetSongPlayerUrl(f.Name)) title="view"><SfIcon IconCss="fas fa-solid fa-eye" /></SfButton>
                        </div>
                    </div>
                }

                <!-- Bottom row: Add to Cart and Share buttons -->
                <div class="card-bottom-row">
                    <AuthorizeView>
                        <Authorized>
                            @if (!owned && !_hasActiveSubscription)
                            {
                                <div class="cart-button-wrapper">
                                    <SfButton CssClass="@($"card-cart-button {(inCart ? "in-cart" : "")} {(_animatingCartButtons.Contains(f.Name) ? "animating" : "")}")"
                                              OnClick="@(args => ToggleCartItem(f.Name))"
                                              Title="@(inCart ? "Remove from Cart" : "Add to Cart")">
                                        @if (inCart)
                                        {
                                            <SfIcon IconCss="fas fa-regular fa-circle-check" />
                                            <span>Added</span>
                                        }
                                        else
                                        {
                                            <SfIcon IconCss="fas fa-shopping-cart" />
                                            <span>$@GetSongPrice(f.Name).ToString("F2")</span>
                                        }
                                    </SfButton>
                                    @if (_animatingCartButtons.Contains(f.Name))
                                    {
                                        <div class="music-note-float">♪</div>
                                    }
                                </div>
                            }
                        </Authorized>
                    </AuthorizeView>
                    
                    <!-- Facebook Share Button -->
                    <FacebookShareButton ShareUrl="@GetSongShareUrl(f.Name)" 
                                       Layout="button_count" 
                                       Size="small" 
                                       CssClass="share-button-card" />
                </div>
            </SfCard>
        }
    </div>
}

<style>
    .e-card.music-card {
        border-radius: 12px;
        overflow: hidden;
        padding: 8px;
    }
</style>