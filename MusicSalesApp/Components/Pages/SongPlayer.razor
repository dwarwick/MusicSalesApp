@page "/song/{SongTitle}"
@inherits SongPlayerModel
@using MusicSalesApp.Services
@using MusicSalesApp.Components.Shared

<PageTitle>@GetDisplayTitle()</PageTitle>

<div class="spotify-container">
    @if (_loading)
    {
        <div class="loading-state">
            <p>Loading...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        <div class="error-state">
            <div class="alert alert-danger">@_error</div>
        </div>
    }
    else
    {
        <!-- Song Header Section -->
        <div class="song-header">
            <div class="album-art-container">
                <div class="title-container">
                    @if (!string.IsNullOrEmpty(_albumArtUrl))
                    {
                        <img src="@_albumArtUrl" alt="Album Art" class="album-art" />
                    }
                    else
                    {
                        <div class="album-art-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="placeholder-icon">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                            </svg>
                        </div>
                    }
                    @if (_ownsSong)
                    {
                        <div class="owned-badge">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                    }
                    <h1 class="song-title">@GetDisplayTitle()</h1>
                </div>
            </div>
            <div class="song-info">

                <!-- Play Button Section -->
                <div class="action-controls">
                    <button class="play-button-large" @onclick="TogglePlay" title="@(_isPlaying ? "Pause" : "Play")">
                        @if (_isPlaying)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                            </svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        }
                    </button>

                    <!-- Facebook Share Button -->
                    <FacebookShareButton ShareUrl="@GetShareUrl()" 
                                       Layout="button_count" 
                                       Size="large" 
                                       CssClass="share-button-action" />

                    <!-- Add to Cart Button -->
                    <AuthorizeView>
                        <Authorized>
                            @if (!_ownsSong && !_hasActiveSubscription)
                            {
                                <div class="cart-button-wrapper">
                                    <button class="@($"cart-button-large {(_inCart ? "in-cart" : "")} {(_cartAnimating ? "animating" : "")}")"
                                            @onclick="ToggleCart"
                                            title="@(_inCart ? "Remove from Cart" : "Add to Cart")">
                                        @if (_inCart)
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="cart-icon-large">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                            </svg>
                                            <span>Added to Cart</span>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="cart-icon-large">
                                                <path d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zm-9.83-3.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.49 0-.55-.45-1-1-1H5.21l-.94-2H1v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25z" />
                                            </svg>
                                            <span>$@_songPrice.ToString("F2") - Add to Cart</span>
                                        }
                                    </button>

                                    @if (_cartAnimating)
                                    {
                                        <span class="music-note-float-player">â™ª</span>
                                    }
                                </div>
                            }
                        </Authorized>
                    </AuthorizeView>
                </div>


                @if (GetTrackLengthSeconds() is double trackLength)
                {
                    <span class="album-track-info">Duration: @FormatTime(trackLength)</span>
                }
                @if (_hasActiveSubscription)
                {
                    <span class="subscription-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                        </svg>
                        Unlimited Access (Subscribed)
                    </span>
                }
                else if (!_ownsSong)
                {
                    <span class="preview-label">Preview Only (60 seconds)</span>
                }

                <!-- Like/Dislike Buttons -->
                @if (GetSongMetadataId() > 0)
                {
                    <div class="song-like-dislike">
                        <LikeDislikeButtons SongMetadataId="GetSongMetadataId()" />
                    </div>
                }
            </div>
        </div>        

    <!-- Hidden Audio Element -->
    <audio @ref="_audioElement"
           src="@_streamUrl"
           preload="auto"
           style="display:none;"></audio>

    <!-- Bottom Player Bar -->
    <div class="player-bar mt-auto">
        <div class="controls-wrapper">
            <span class="time-spacer"></span>
            <div class="player-controls-row">
                <div class="player-controls">
                    <button class="control-button @(_shuffleEnabled ? "active" : "")" @onclick="ToggleShuffle" title="Shuffle">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                            <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" />
                        </svg>
                    </button>
                    <button class="control-button" title="Previous">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
                        </svg>
                    </button>
                    <button class="play-button-small" @onclick="TogglePlay" title="@(_isPlaying ? "Pause" : "Play")">
                        @if (_isPlaying)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon-small">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                            </svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon-small">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        }
                    </button>
                    <button class="control-button" title="Next">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                        </svg>
                    </button>
                    <button class="control-button @(_repeatEnabled ? "active" : "")" @onclick="ToggleRepeat" title="Repeat">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                            <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" />
                        </svg>
                    </button>
                </div>
                <div class="volume-controls">
                    <button class="control-button" @onclick="ToggleMute" title="@(_isMuted ? "Unmute" : "Mute")">
                        @if (_isMuted || GetDisplayVolume() == 0)
                        {
                            <!-- Muted icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z" />
                            </svg>
                        }
                        else if (GetDisplayVolume() < 0.5)
                        {
                            <!-- Low volume icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                                <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z" />
                            </svg>
                        }
                        else
                        {
                            <!-- High volume icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                            </svg>
                        }
                    </button>
                    <div @ref="_volumeBarContainer" class="volume-bar-container" @onclick="OnVolumeBarClick">
                        <div class="volume-bar" style="width: @(GetDisplayVolume() * 100)%;">
                            <div class="volume-thumb"></div>
                        </div>
                    </div>
                </div>
            </div>
            <span class="time-spacer"></span>
        </div>
        <div class="progress-container">
            <span class="time-display">@FormatTime(_currentTime)</span>
            <div @ref="_progressBarContainer" class="progress-bar-container @(IsProgressBarRestricted() ? "restricted" : "")" @onclick="OnProgressBarClick">
                <div class="progress-bar" style="width: @(GetProgressBarWidth())%;">
                    <div class="progress-thumb"></div>
                </div>
                @if (IsProgressBarRestricted())
                {
                    <div class="progress-limit-marker" style="left: @(GetPreviewLimitPercentage())%;"></div>
                }
            </div>
            <span class="time-display">@FormatTime(GetDisplayDuration())</span>
        </div>
    </div>
    }
</div>
